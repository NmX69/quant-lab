# project_tree.txt
# Purpose: High-level map of the Quant-Lab project structure.
# Notes: Update this file whenever you add/remove major modules.


================================================================================
ROOT
================================================================================

quant_lab.py
  - Purpose: Main Quant-Lab entrypoint. Starts the Tkinter GUI.
  - Major APIs:
      - main() – creates Tk root, instantiates BacktesterGUI, runs mainloop().

config.json
  - Purpose: User configuration for Quant-Lab (GUI selections, slider values, etc.).
  - Notes:
      - Written/read by core.config_manager.
      - Stores last-used file/strategy/mode/slider positions and router mappings.


================================================================================
data/  (CSV market data and manifest)
================================================================================

data/
  - Purpose: All CSV price series and the manifest describing them.
  - Important contents:
      - manifest.json – describes available trading pairs, timeframes, candle counts.
      - *.csv – per-asset OHLCV files (e.g., BTCUSDT_1h.csv).

  - Notes:
      - Quant-Lab expects manifest.json to be in this folder.
      - CSVs are referenced by filename from manifest.json.


================================================================================
strategies/  (JSON strategy definitions)
================================================================================

strategies/
  - Purpose: Strategy definitions in declarative JSON form.
  - Example files:
      - range_mean_reversion.json
      - range_rsi_bb.json
      - ranging_stochastic.json
      - trending_ema_crossover.json
      - trend_macd.json
  - Notes:
      - Each JSON specifies:
          - name, regime, direction
          - entry.conditions list (indicator conditions)
          - exit.stop_loss / exit.take_profit / signal_exit list
          - risk section (sizing mode, risk_per_trade_pct)
      - Loaded by core.strategy_loader and used by engine/backtest_runner.


================================================================================
core/  (engine, risk, indicators, routing, reporting, optimization)
================================================================================

core/engine.py
  - Purpose: Core backtest engine. Iterates candles, applies strategies, tracks equity.
  - Major APIs:
      - run_backtest(
            df: pd.DataFrame,
            asset: str,
            strategy: Dict,
            mode: str,
            use_router: bool,
            router_mappings: Optional[Dict[str, str]],
            position_pct: float,
            risk_pct: float,
            reward_rr: float,
        ) -> Tuple[str, BacktestResult]
        * Main public entrypoint for running a backtest.
  - Internals (delegated to other modules):
      - Uses core.sizing.get_mode_params and other sizing helpers.
      - Uses core.conditions.evaluate_condition / invert_condition.
      - Uses core.exits helpers to build and record trades.
      - Uses core.state helpers to track capital, position, regime counts, equity.
      - Uses core.results_builder to build the final BacktestResult and summary string.

core/sizing.py
  - Purpose: All risk and position sizing logic, including mode defaults.
  - Major APIs:
      - get_mode_params(mode: str) -> Tuple[Decimal, float, float]
        * Returns (risk_per_trade_frac, fixed_rr, adx_threshold).
      - Additional helpers (names may vary) to:
        * Interpret GUI parameters (position_pct, risk_pct, reward_rr).
        * Compute position_size, stop_loss_pct, take_profit_pct.
        * Respect FEE_PCT and strategy JSON defaults for stop/take-profit.
  - Notes:
      - ATR sizing is currently mapped to equity_pct behavior.

core/conditions.py
  - Purpose: Indicator-based entry/exit condition evaluation.
  - Major APIs:
      - invert_condition(cond: Dict) -> Dict
        * Invert a condition (e.g., > becomes <=, cross_over becomes cross_under).
      - evaluate_condition(row: pd.Series, condition: Dict) -> bool
        * Evaluate a single condition against the current candle/indicator row.
      - evaluate_conditions(row: pd.Series, conditions: List[Dict]) -> bool
        * Evaluate AND of multiple conditions.
  - Notes:
      - Supports condition types such as RSI thresholds, MACD crossovers, BB tests, etc.

core/exits.py
  - Purpose: Exit-signal helpers for stop-loss, take-profit, and signal-based exits.
  - Major APIs:
      - check_stop_loss(...)
      - check_take_profit(...)
      - check_signal_exit(...)
        * Evaluate whether a given exit condition is hit on this candle.
  - Notes:
      - Works closely with core.state and core.engine to finalize trades.

core/state.py
  - Purpose: Encapsulate backtest state (equity, open position, trade logs, regime stats).
  - Major APIs:
      - BacktestState – object that tracks:
          * current_equity, position_size, open_trade, trade_logs, equity_curve, regime_counts.
      - Methods to:
          * open_trade(...)
          * update_equity(...)
          * close_trade(...)
  - Notes:
      - Intended to keep engine.run_backtest relatively stateless and clean.

core/results_builder.py
  - Purpose: Convert raw BacktestState/TradeLog data into BacktestResult and summary text.
  - Major APIs:
      - build_backtest_result(
            state: BacktestState,
            asset: str,
            mode: str,
            strategy_name: str,
            use_router: bool,
            router_mappings: Optional[Dict[str, str]],
        ) -> BacktestResult
      - build_summary_text(result: BacktestResult) -> str
        * Builds the human-readable multi-line summary printed in CLI/GUI.
  - Notes:
      - Responsible for computing basic metrics like total_return_pct, max_dd, winrate, etc.

core/indicators.py
  - Purpose: Compute technical indicators and regime flags for raw OHLCV data.
  - Major APIs:
      - add_indicators_and_regime(df: pd.DataFrame) -> pd.DataFrame
        * Adds all required indicator columns (MACD, EMAs, RSI, Stoch, BBs, ADX, etc.).
        * Adds regime booleans/labels: trending_up, trending_down, ranging.
  - Notes:
      - Must be called before core.engine.run_backtest.

core/strategy_loader.py
  - Purpose: Load JSON strategy definitions and provide access by name.
  - Major APIs:
      - load_strategies() -> None
        * Loads/refreshes strategy definitions from the strategies directory.
      - list_strategies() -> List[str]
        * Returns names of all available strategies.
      - get_strategy(name: str) -> Dict
        * Returns a single strategy config dict (entry/exit/risk sections).

core/regime_router.py
  - Purpose: Map the current regime (trending_up, trending_down, ranging) to a strategy.
  - Major APIs:
      - get_active_strategy(regime: str, mappings: Dict[str, str]) -> Dict
        * Returns appropriate strategy dict for the given regime, using strategy_loader.

core/results.py
  - Purpose: Data structures for backtest results and trade logs.
  - Major APIs:
      - TradeLog – record of a single trade:
        * fields such as entry_ts, exit_ts, entry_price, exit_price, pnl, pnl_pct,
          mae, mfe, pnl_R, reward_multiple, stop_distance_pct, take_profit_multiple,
          hold_time_hours, trade_type, regime, strategy, exit_reason.
      - BacktestResult – aggregate result for a run:
        * fields such as asset, mode, final_equity, total_return_pct, total_trades,
          winrate, sharpe, max_dd, max_dd_pct, regime_changes, regime_counts,
          regime_pnl, equity_curve, trades.
        * methods:
          - summary_str() -> str – formatted console-style summary.
          - save_trades(results_dir: str) -> None – save trades CSV under results/.

core/reporting.py
  - Purpose: Compute advanced analytics (expectancy, volatility, streaks, Sortino, MAR, regime stats) and export reports.
  - Major APIs:
      - build_report(result: BacktestResult) -> Dict[str, Any]
        * Consumes a BacktestResult + its TradeLog list and returns a nested analytics dict
          with sections: meta, risk, streaks, drawdown, regimes.
      - export_report_json(report: Dict[str, Any], path: str) -> None
        * Save analytics report to JSON on disk.
      - export_report_csv(report: Dict[str, Any], path: str) -> None
        * Save flattened analytics rows to CSV.

core/optimizer.py
  - Purpose: Grid-search optimizers for risk envelope and strategy JSON parameters.
  - Major APIs:
      - grid_search_single_asset(asset_file: str, strategy_name: str, mode: str,
                                 use_router: bool, param_grid: Dict[str, List[float]],
                                 max_candles: int,
                                 strategy_mappings: Optional[Dict[str, str]])
        * Sweeps position_pct / risk_pct / reward_rr for one asset/strategy/mode.
      - grid_search_all_assets(timeframe: str, strategy_name: str, mode: str,
                               use_router: bool, param_grid: Dict[str, List[float]],
                               max_candles: int,
                               strategy_mappings: Optional[Dict[str, str]])
        * Sweeps the same envelope across all assets in manifest.json and returns per-asset best rows.
      - grid_search_strategy_params_single_asset(asset_file: str, strategy_name: str,
                                                 mode: str, strategy_param_grid: Dict[str, List[Any]],
                                                 position_pct: float, risk_pct: float, reward_rr: float,
                                                 max_candles: int)
        * Grid-search over strategy JSON paths (e.g. entry.conditions[1].below,
          exit.stop_loss, exit.take_profit) with a fixed engine envelope.
      - select_good_region(df: pd.DataFrame, min_sharpe: Optional[float],
                           max_dd_pct: Optional[float], min_trades: Optional[int],
                           min_return_pct: Optional[float]) -> pd.DataFrame
        * Filter optimization results down to a "good" region in risk space.
      - summarize_region(df: pd.DataFrame, top_n: int) -> pd.DataFrame
        * Sort + truncate to the most interesting slices for display.

core/backtest_runner.py
  - Purpose: Orchestrate backtests at the “app” level, without any GUI code.
  - Major APIs:
      - run_single_backtest(
            asset_file: str,
            strategy_name: str,
            mode: str,
            use_router: bool,
            max_candles: int,
            strategy_mappings: Optional[Dict],
            position_pct: float,
            risk_pct: float,
            reward_rr: float,
        ) -> Tuple[str, str, BacktestResult]
        * Loads CSV, applies indicators, runs engine.run_backtest,
          saves trades, returns:
            - preamble_text (load/indicator info + header),
            - summary_text (BacktestResult summary with header normalized),
            - BacktestResult.
      - run_all_strategies_backtest(
            asset_file: str,
            mode: str,
            max_candles: int,
            position_pct: float,
            risk_pct: float,
            reward_rr: float,
        ) -> Tuple[pd.DataFrame, str]
        * Runs all strategies for one asset; returns DataFrame with
          Strategy/Final/Return %/Trades/Max DD %, plus an error_log string.
      - run_all_assets_backtest(
            timeframe: str,
            strategy_name: str,
            mode: str,
            use_router: bool,
            max_candles: int,
            strategy_mappings: Optional[Dict],
            position_pct: float,
            risk_pct: float,
            reward_rr: float,
        ) -> Tuple[pd.DataFrame, str]
        * Runs one strategy across all assets in manifest.json; returns DataFrame
          with Asset/Final/Return %/Trades/Max DD %, plus an error_log string.


================================================================================
gui/  (Tkinter GUI, styling, layout, and display helpers)
================================================================================

gui/backtester_gui.py
  - Purpose: Main Tkinter GUI class wiring user controls to backtest runner.
  - Major APIs:
      - class BacktesterGUI(tk.Tk-like):
        * Manages all Tk variables (strategy, file, mode, run_mode, sliders, switches).
        * Loads config via core.config_manager.load_config().
        * Handles core GUI flows:
            - scan_data_files() – populates data file dropdown from manifest.json.
            - load_strategies() – populates strategy dropdowns from strategy_loader.
            - toggle_router_ui() – enables/disables router-related controls.
            - toggle_equity_area() – shows/hides equity plot canvas.
            - run_backtest() – dispatches to:
                - _run_single(...)
                - _run_all_strategies(...)
                - _run_all_assets(...)
        * Optimizer GUI (Phase C):
            - create_menu() – adds Data / Reports / Optimize menus.
            - open_single_optimizer_window()
              * Grid-search risk envelope for the selected asset/strategy.
            - open_all_assets_optimizer_window()
              * Grid-search risk envelope across all assets in a timeframe.
            - open_strategy_param_optimizer_window()
              * Grid-search strategy JSON parameters (e.g. RSI threshold, SL/TP) for one asset.
        * Uses:
            - core.backtest_runner.* backtest functions.
            - core.optimizer.* for grid-search logic and region filters.
            - core.reporting.build_report for advanced analytics in Reports menu.
            - gui.results_display.* for plotting and summary formatting.
            - gui.styles.setup_styles() for consistent look-and-feel.
            - gui.layout.create_left_panel/create_right_panel for widget construction.
      - copy_output() – copies current summary text to clipboard.

gui/layout.py
  - Purpose: Build the left (controls) and right (output) panels for BacktesterGUI.
  - Major APIs:
      - create_left_panel(gui: BacktesterGUI) -> None
        * Creates:
            - timeframe, file, strategy selectors
            - regime router frame and combos
            - mode selector
            - run_mode selector
            - max_candles entry
            - checkboxes for equity curve and router usage
            - RUN BACKTEST button
      - create_right_panel(gui: BacktesterGUI) -> None
        * Creates:
            - output_text (ScrolledText) for logs/summary
            - risk sliders (position_pct, risk_pct, reward_rr)
            - COPY OUTPUT button
            - Matplotlib Figure + canvas for equity curve plot.

gui/results_display.py
  - Purpose: GUI-agnostic helpers for plotting equity and formatting summary tables.
  - Major APIs:
      - plot_equity_curve(fig: Figure, trades: List[TradeLog]) -> None
        * Draws equity curve based on TradeLog pnl; used by GUI.
      - format_all_strategies_summary(df_res: pd.DataFrame) -> str
        * Returns printable multi-line summary of strategy comparison.
      - format_all_assets_summary(df_res: pd.DataFrame) -> str
        * Returns printable multi-line summary of asset comparison.

gui/styles.py
  - Purpose: Centralize ttk style configuration.
  - Major APIs:
      - setup_styles() -> None
        * Applies dark theme / fonts / paddings to ttk widgets.


================================================================================
How to use this file with AI
================================================================================

- When starting a new chat about this project, paste **this entire file** first.
- Keep this tree updated as you add:
    - new modes (scanner, live trading, etc.),
    - new strategy/risk modules,
    - new GUI screens.

# /project_tree.txt v1.3 (349 lines)